/* jshint forin:true, noarg:true, noempty:true, eqeqeq:true, boss:true, undef:true, curly:true, browser:true, jquery:true */
/*
 * jQuery MultiSelect UI Widget 1.17pre
 * Copyright (c) 2012 Eric Hynds
 *
 * http://www.erichynds.com/jquery/jquery-ui-multiselect-widget/
 *
 * Depends:
 *   - jQuery 1.4.2+
 *   - jQuery UI 1.8 widget factory
 *
 * Optional:
 *   - jQuery UI effects
 *   - jQuery UI position utility
 *
 * Dual licensed under the MIT and GPL licenses:
 *   http://www.opensource.org/licenses/mit-license.php
 *   http://www.gnu.org/licenses/gpl.html
 *
 */
(function(e,t){var i=0;var s=e(document);e.widget("ech.multiselect",{options:{header:true,height:175,minWidth:225,classes:"",checkAllText:"Check all",uncheckAllText:"Uncheck all",noneSelectedText:"Select options",showCheckAll:true,showUncheckAll:true,selectedText:"# selected",selectedList:0,closeIcon:"ui-icon-circle-close",show:null,hide:null,autoOpen:false,multiple:true,position:{},appendTo:"body",menuWidth:null,selectedListSeparator:", "},_create:function(){var t=this.element;var s=this.options;this.speed=e.fx.speeds._default;this._isOpen=false;this._namespaceID=this.eventNamespace||"multiselect"+i;var l=(this.button=e('<button type="button"><span class="ui-icon ui-icon-triangle-1-s"></span></button>')).addClass("ui-multiselect ui-widget ui-state-default ui-corner-all").addClass(s.classes).attr({title:t.attr("title"),tabIndex:t.attr("tabIndex"),id:t.attr("id")?t.attr("id")+"_ms":null}).prop("aria-haspopup",true).insertAfter(t),a=(this.buttonlabel=e("<span />")).html(s.noneSelectedText).appendTo(l),n=(this.menu=e("<div />")).addClass("ui-multiselect-menu ui-widget ui-widget-content ui-corner-all").addClass(s.classes).appendTo(e(s.appendTo)),u=(this.header=e("<div />")).addClass("ui-widget-header ui-corner-all ui-multiselect-header ui-helper-clearfix").appendTo(n),r=(this.headerLinkContainer=e("<ul />")).addClass("ui-helper-reset").html(function(){if(s.header===true){var e="";if(s.showCheckAll)e='<li><a class="ui-multiselect-all" href="#"><span class="ui-icon ui-icon-check"></span><span>'+s.checkAllText+"</span></a></li>";if(s.showUncheckAll)e+='<li><a class="ui-multiselect-none" href="#"><span class="ui-icon ui-icon-closethick"></span><span>'+s.uncheckAllText+"</span></a></li>";return e}else if(typeof s.header==="string"){return"<li>"+s.header+"</li>"}else{return""}}).append('<li class="ui-multiselect-close"><a href="#" class="ui-multiselect-close"><span class="ui-icon '+s.closeIcon+'"></span></a></li>').appendTo(u),o=(this.checkboxContainer=e("<ul />")).addClass("ui-multiselect-checkboxes ui-helper-reset").appendTo(n);this._bindEvents();this.refresh(true);if(!s.multiple){n.addClass("ui-multiselect-single")}i++;t.hide()},_init:function(){if(this.options.header===false){this.header.hide()}if(!this.options.multiple){this.headerLinkContainer.find(".ui-multiselect-all, .ui-multiselect-none").hide()}if(this.options.autoOpen){this.open()}if(this.element.is(":disabled")){this.disable()}},refresh:function(t){var s=0;var l=this.element;var a=this.options;var n=this.menu;var u=this.checkboxContainer;var r="";var o=e("<ul/>").addClass("ui-multiselect-checkboxes ui-helper-reset");var h=l.attr("id")||i++;function c(t,l){var n=t.title?t.title:null;var u=t.value;var r="ui-multiselect-"+i+"-"+(t.id||h+"-option-"+s++);var o=t.disabled;var c=t.selected;var d=["ui-corner-all"];var p=[];if(o){p.push("ui-multiselect-disabled");d.push("ui-state-disabled")}if(t.className){p.push(t.className)}if(c&&!a.multiple){d.push("ui-state-active")}if(l){p.push("ui-multiselect-optgrp-child")}var f=e("<li/>").addClass(p.join(" "));var m=e("<label/>").attr({for:r,title:n}).addClass(d.join(" ")).appendTo(f);var v=e("<input/>").attr({name:"multiselect_"+h,type:a.multiple?"checkbox":"radio",value:u,title:n,id:r,checked:c?"checked":null,"aria-selected":c?"true":null,disabled:o?"disabled":null,"aria-disabled":o?"true":null}).appendTo(m);e("<span/>").text(e(t).text()).appendTo(m);return f}if(this.options.header){if(!this.options.multiple){this.headerLinkContainer.find(".ui-multiselect-all, .ui-multiselect-none").hide()}else{this.headerLinkContainer.find(".ui-multiselect-all, .ui-multiselect-none").show()}}l.children().each(function(t){var i=e(this);if(this.tagName==="OPTGROUP"){var s=e("<li/>").addClass("ui-multiselect-optgroup-label "+this.className).appendTo(o);var l=e("<a/>").attr("href","#").text(this.getAttribute("label")).appendTo(s);i.children().each(function(){var e=c(this,true).appendTo(o)})}else{var a=c(this).appendTo(o)}});this.menu.find(".ui-multiselect-checkboxes").remove();this.menu.append(o);this.labels=n.find("label");this.inputs=this.labels.children("input");this._setButtonWidth();this._setMenuWidth();this.button[0].defaultValue=this.update();if(!t){this._trigger("refresh")}},update:function(){var t=this.options;var i=this.inputs;var s=i.filter(":checked");var l=s.length;var a;if(l===0){a=t.noneSelectedText}else{if(e.isFunction(t.selectedText)){a=t.selectedText.call(this,l,i.length,s.get())}else if(/\d/.test(t.selectedList)&&t.selectedList>0&&l<=t.selectedList){a=s.map(function(){return e(this).next().text()}).get().join(t.selectedListSeparator)}else{a=t.selectedText.replace("#",l).replace("#",i.length)}}this._setButtonValue(a);return a},_setButtonValue:function(e){this.buttonlabel.text(e)},_bindEvents:function(){var t=this;var i=this.button;function l(){t[t._isOpen?"close":"open"]();return false}i.find("span").bind("click.multiselect",l);i.bind({click:l,keypress:function(e){switch(e.which){case 27:case 38:case 37:t.close();break;case 39:case 40:t.open();break}},mouseenter:function(){if(!i.hasClass("ui-state-disabled")){e(this).addClass("ui-state-hover")}},mouseleave:function(){e(this).removeClass("ui-state-hover")},focus:function(){if(!i.hasClass("ui-state-disabled")){e(this).addClass("ui-state-focus")}},blur:function(){e(this).removeClass("ui-state-focus")}});this.header.delegate("a","click.multiselect",function(i){if(e(this).hasClass("ui-multiselect-close")){t.close()}else{t[e(this).hasClass("ui-multiselect-all")?"checkAll":"uncheckAll"]()}i.preventDefault()});this.menu.delegate("li.ui-multiselect-optgroup-label a","click.multiselect",function(i){i.preventDefault();var s=e(this);var l=s.parent().nextUntil(":not(.ui-multiselect-optgrp-child)").find("input:visible:not(:disabled)");var a=l.get();var n=s.parent().text();if(t._trigger("beforeoptgrouptoggle",i,{inputs:a,label:n})===false){return}t._toggleChecked(l.filter(":checked").length!==l.length,l);t._trigger("optgrouptoggle",i,{inputs:a,label:n,checked:a[0].checked})}).delegate("label","mouseenter.multiselect",function(){if(!e(this).hasClass("ui-state-disabled")){t.labels.removeClass("ui-state-hover");e(this).addClass("ui-state-hover").find("input").focus()}}).delegate("label","keydown.multiselect",function(i){if(i.which===82)return;if(i.which>111&&i.which<124)return;i.preventDefault();switch(i.which){case 9:case 27:t.close();break;case 38:case 40:case 37:case 39:t._traverse(i.which,this);break;case 13:e(this).find("input")[0].click();break}}).delegate('input[type="checkbox"], input[type="radio"]',"click.multiselect",function(i){var s=e(this);var l=this.value;var a=s.parent().find("span").text();var n=this.checked;var u=t.element.find("option");if(this.disabled||t._trigger("click",i,{value:l,text:a,checked:n})===false){i.preventDefault();return}s.focus();s.prop("aria-selected",n);u.each(function(){if(this.value===l){this.selected=n}else if(!t.options.multiple){this.selected=false}});if(!t.options.multiple){t.labels.removeClass("ui-state-active");s.closest("label").toggleClass("ui-state-active",n);t.close()}t.element.trigger("change");setTimeout(e.proxy(t.update,t),10)});s.bind("mousedown."+t._namespaceID,function(i){var s=i.target;if(t._isOpen&&s!==t.button[0]&&s!==t.menu[0]&&!e.contains(t.menu[0],s)&&!e.contains(t.button[0],s)){t.close()}});e(this.element[0].form).bind("reset."+this._namespaceID,function(){setTimeout(e.proxy(t.refresh,t),10)})},_getMinWidth:function(){var e=this.options.minWidth;var t=0;switch(typeof e){case"number":t=e;break;case"string":var i=e[e.length-1];t=e.match(/\d+/);if(i==="%"){t=this.element.parent().outerWidth()*(t/100)}else{t=parseInt(e,10)}break}return t},_setButtonWidth:function(){var e=this.element.outerWidth();var t=this._getMinWidth();if(e<t){e=t}this.button.outerWidth(e)},_setMenuWidth:function(){var e=this.menu;var t=this.button.outerWidth()<=0?this._getMinWidth():this.button.outerWidth();e.outerWidth(this.options.menuWidth||t)},_traverse:function(t,i){var s=e(i);var l=t===38||t===37;var a=s.parent()[l?"prevAll":"nextAll"]("li:not(.ui-multiselect-disabled, .ui-multiselect-optgroup-label)").first();if(!a.length){var n=this.menu.find("ul").last();this.menu.find("label")[l?"last":"first"]().trigger("mouseover");n.scrollTop(l?n.height():0)}else{a.find("label").trigger("mouseover")}},_toggleState:function(e,t){return function(){if(!this.disabled){this[e]=t}if(t){this.setAttribute("aria-selected",true)}else{this.removeAttribute("aria-selected")}}},_toggleChecked:function(e,t){var i=t&&t.length?t:this.inputs;var s=this;i.each(this._toggleState("checked",e));i.eq(0).focus();this.update();var l={};i.each(function(){l[this.value]=true});this.element.find("option").each(function(){if(!this.disabled&&l[this.value]){s._toggleState("selected",e).call(this)}});if(i.length){this.element.trigger("change")}},_toggleDisabled:function(t){this.button.prop({disabled:t,"aria-disabled":t})[t?"addClass":"removeClass"]("ui-state-disabled");var i=this.menu.find("input");var s="ech-multiselect-disabled";if(t){i=i.filter(":enabled").data(s,true)}else{i=i.filter(function(){return e.data(this,s)===true}).removeData(s)}i.prop({disabled:t,"arial-disabled":t}).parent()[t?"addClass":"removeClass"]("ui-state-disabled");this.element.prop({disabled:t,"aria-disabled":t})},open:function(t){var i=this;var s=this.button;var l=this.menu;var a=this.speed;var n=this.options;var u=[];if(this._trigger("beforeopen")===false||s.hasClass("ui-state-disabled")||this._isOpen){return}var r=l.find("ul").last();var o=n.show;if(e.isArray(n.show)){o=n.show[0];a=n.show[1]||i.speed}if(o){u=[o,a]}r.scrollTop(0).height(n.height);this.position();e.fn.show.apply(l,u);this.labels.filter(":not(.ui-state-disabled)").eq(0).trigger("mouseover").trigger("mouseenter").find("input").trigger("focus");s.addClass("ui-state-active");this._isOpen=true;this._trigger("open")},close:function(){if(this._trigger("beforeclose")===false){return}var t=this.options;var i=t.hide;var s=this.speed;var l=[];if(e.isArray(t.hide)){i=t.hide[0];s=t.hide[1]||this.speed}if(i){l=[i,s]}e.fn.hide.apply(this.menu,l);this.button.removeClass("ui-state-active").trigger("blur").trigger("mouseleave");this._isOpen=false;this._trigger("close")},enable:function(){this._toggleDisabled(false)},disable:function(){this._toggleDisabled(true)},checkAll:function(e){this._toggleChecked(true);this._trigger("checkAll")},uncheckAll:function(){this._toggleChecked(false);this._trigger("uncheckAll")},getChecked:function(){return this.menu.find("input").filter(":checked")},getUnchecked:function(){return this.menu.find("input").not(":checked")},destroy:function(){e.Widget.prototype.destroy.call(this);s.unbind(this._namespaceID);e(this.element[0].form).unbind(this._namespaceID);this.button.remove();this.menu.remove();this.element.show();return this},isOpen:function(){return this._isOpen},widget:function(){return this.menu},getButton:function(){return this.button},position:function(){var t=this.options;if(e.ui.position&&!e.isEmptyObject(t.position)){t.position.of=t.position.of||this.button;this.menu.show().position(t.position).hide()}else{var i=this.button.offset();this.menu.css({top:i.top+this.button.outerHeight(),left:i.left})}},_setOption:function(t,i){var s=this.menu;switch(t){case"header":s.find("div.ui-multiselect-header")[i?"show":"hide"]();break;case"checkAllText":s.find("a.ui-multiselect-all span").eq(-1).text(i);break;case"uncheckAllText":s.find("a.ui-multiselect-none span").eq(-1).text(i);break;case"height":s.find("ul").last().height(parseInt(i,10));break;case"minWidth":case"menuWidth":this.options[t]=i;this._setButtonWidth();this._setMenuWidth();break;case"selectedText":case"selectedList":case"noneSelectedText":this.options[t]=i;this.update();break;case"classes":s.add(this.button).removeClass(this.options.classes).addClass(i);break;case"multiple":s.toggleClass("ui-multiselect-single",!i);this.options.multiple=i;this.element[0].multiple=i;this.refresh();break;case"position":this.position();break;case"selectedListSeparator":this.options[t]=i;this.button[0].defaultValue=this.update();break}e.Widget.prototype._setOption.apply(this,arguments)}})})(jQuery);